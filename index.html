<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="main.css">
		<script src="jquery-2.2.0.min.js"></script>
		<script src="peg-0.9.0.min.js"></script>
		<script src="jsDump.js"></script>
		<script src="util.js"></script>
		<script>
			var vms = {};
		</script>
		<script src="VMSimple.js"></script>
		<script src="VMStandard.js"></script>
		<script>
			
			var form = (function() {
				
				function getDestBody()
				{
					return $("#dest").contents().find("body");
				}
				
				var views = ["html", "dump", "plain"];
				
				return {
					setDestView: function(view) {
						views.map(function(view2) {
							getDestBody().toggleClass(view2, view === view2)
						});
					},
					setDestHTML: function(html) {
						getDestBody().empty();
						getDestBody().html(html);
					},
					setDestDom: function(dom) {
						getDestBody().empty();
						getDestBody().append(dom);
					},
					setDestText: function(text) {
						getDestBody().empty();
						getDestBody().text(text);
					},
					getVM: function() {
						return $("#vm").val();
					},
					createVM: function() {
						return new vms[this.getVM()];
					},
					setStatus: function(text) {
						return $("#status").html(text);
					},
					setFocus: function() {
						$("#src").focus();
					},
					getSrc: function() {
						return $("#src").val();
					},
					setSrc: function(text) {
						return $("#src").val(text);
					},
					getView: function() {
						return $("input[name='view']:checked").val();
					},
					setView: function(view) {
						$("input[name='view'][value='" + view + "']").prop('checked', true);
					},
					initialize: function(changed) {
						// events
						$("input[name='view']:radio").change(changed);
						$("#src").keyup(changed);
						$("#dest").load(changed);
						$("#vm").change(changed);
						$("#vm").change(function() { $("#vm_hidden").val($("#vm").val()); });
						
						// default values
						if (this.getSrc() === "") this.setSrc("Damage: \\2d+4\\");
						if (this.getView() === undefined) this.setView("html");
						$("#dest").attr("src", "dest.html");
						Object.keys(vms).forEach(function (key) {
							var $option = $("<option>");
							$option.attr("value", key);
							$option.text(key);
							$("#vm").append($option);
						});
						$("#vm").val($("#vm_hidden").val() || "Standard");
					},
				};
			})();
			
			var parser;
			
			$(function() {
				$.ajax({
					type: "GET",
					url: "fluorite5.pegjs",
					dataType: "text",
					success: function(data) {
						try {
							parser = PEG.buildParser(data, {
								cache: true,
								allowedStartRules: [
									"Expression",
								],
							});
							form.setStatus("");
							form.initialize(changed);
							form.setFocus();
						} catch(e) {
							form.setStatus("Parser: Syntax Error: " + e);
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						form.setStatus("Parser: Network Error: " + textStatus);
					},
				})
			});
			
			var src;
			var view;
			var vm;
			
			function changed(force)
			{
				var src2 = form.getSrc();
				var view2 = form.getView();
				var vm2 = form.getVM();
				var res;
				if (force !== true) {
					if (src === src2 && view === view2 && vm === vm2) return;
				}
				
				src = src2;
				view = view2;
				vm = vm2;
				
				try {
					res = parser.parse(src, {
						startRule: "Expression",
					});
				} catch(e) {
					form.setDestView("plain");
					form.setDestText(e);
					return;
				}
				
				form.setDestView(view);
				if (view === "html") {
					form.setDestHTML(buildHTML(res));
				} else if (view === "plain") {
					form.setDestText(buildPlain(res));
				} else if (view === "dump") {
					form.setDestText(buildDump(res));
				}
			}

			function buildPlain(res)
			{
				var text = [res[0]];
				for (var i = 1; i < res.length; i += 2) {
					buildPlainFormula(text, res[i][0], res[i][1]);
					text.push(res[i + 1]);
				}
				return text.join("");
			}

			function buildPlainFormula(text, src, code)
			{
				var vm = form.createVM();
				var set;
				try {
					res = code(vm, "get");
				} catch(e) {
					res = "" + e;
				}
				text.push(res);
			}

			function buildDump(res)
			{
				var data = [res[0]];
				for (var i = 1; i < res.length; i += 2) {
					buildDumpFormula(data, res[i][0], res[i][1]);
					data.push(res[i + 1]);
				}
				return jsDump.parse(data);
			}

			function buildDumpFormula(data, src, code)
			{
				var vm = form.createVM();
				var set;
				try {
					res = code(vm, "get");
				} catch(e) {
					res = "" + e;
				}
				data.push(res);
			}

			function buildHTML(res)
			{
				var html = [convHtml(res[0])];
				for (var i = 1; i < res.length; i += 2) {
					buildHTMLFormula(html, res[i][0], res[i][1]);
					html.push(convHtml(res[i + 1]));
				}
				return html.join("");
			}

			function buildHTMLFormula(html, src, code)
			{
				var buttonScript = 'href="javascript: void(0);" onclick="dicebot_script_openclose(this)"';
				var buttonReport = 'href="javascript: void(0);" onclick="dicebot_report_openclose(this)"';
				var vm = form.createVM();
				var res;
				try {
					res = code(vm, "get");
				} catch(e) {
					res = "" + e;
				}
				
				html.push('<span class="dicebot_container">');
				{
					html.push('<span class="dicebot_script_container">');
					{
						html.push('<span class="dicebot_script">');
						{
							html.push('<a ' + buttonScript + '>');
							html.push(convHtml(src));
							html.push("</a>");
						}
						html.push("</span>");

						html.push('<span class="dicebot_report">');
						{
							var dices = vm.dices || [];
							var report = dices.map(function(item) {
								return "[" + item.join(", ") + "]";
							}).join(", ");

							html.push('<a ' + buttonReport + '>');
							html.push(report);
							html.push('</a>');
						}
						html.push("</span>");

						html.push('<a class="dicebot_equal" ' + buttonReport + '>=</a>');
					}
					html.push("</span>");

					html.push('<span class="dicebot_result">');
					{
						html.push('<a ' + buttonScript + '>');
						html.push(convHtml(res));
						html.push("</a>");
					}
					html.push("</span>");
				}
				html.push("</span>");
			}

		</script>
	</head>
	<body>
		<div id="container">
			<table>
				<tr id="tr_main">
					<td>
						<table>
							<tr id="tr_main">
								<td rowspan="2"><textarea id="src"></textarea></td>
								<td><iframe id="dest"></iframe></td>
							</tr>
							<tr>
								<td>
									VM:<select id="vm"></select>
									<input type="hidden" id="vm_hidden">
									<input type="radio" name="view" value="html">HTML
									<input type="radio" name="view" value="plain">Plain
									<input type="radio" name="view" value="dump">Dump
									<input type="button" onclick="changed(true)" value="Calculate">
								</td>
							</tr>
						</table>
					</td>
				</tr>
				<tr>
					<td id="status"></td>
				</tr>
				<tr>
					<td>
						Browser: Mozilla Firefox 44.0
					</td>
				</tr>
			</table>
		</div>
	</body>
</html>
