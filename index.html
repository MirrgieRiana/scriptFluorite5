<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="main.css">
		<script src="jquery-2.2.0.min.js"></script>
		<script src="peg-0.9.0.min.js"></script>
		<script src="jsDump.js"></script>
		<script src="util.js"></script>
		<script>
			
			var form = (function() {
				
				function getDestBody()
				{
					return $("#dest").contents().find("body");
				}
				
				var views = ["html", "dump", "plain"];
				
				return {
					setDestView: function(view) {
						views.map(function(view2) {
							getDestBody().toggleClass(view2, view === view2)
						});
					},
					setDestHTML: function(html) {
						getDestBody().empty();
						getDestBody().html(html);
					},
					setDestDom: function(dom) {
						getDestBody().empty();
						getDestBody().append(dom);
					},
					setDestText: function(text) {
						getDestBody().empty();
						getDestBody().text(text);
					},
					setStatus: function(text) {
						return $("#status").html(text);
					},
					getSrc: function() {
						return $("#src").val();
					},
					setSrc: function(text) {
						return $("#src").val(text);
					},
					getView: function() {
						return $("input[name='view']:checked").val();
					},
					setView: function(view) {
						$("input[name='view'][value='" + view + "']").prop('checked', true);
					},
					initialize: function(changed) {
						// events
						$("input[name='view']:radio").change(changed);
						$("#src").keyup(changed);
						$("#dest").load(changed);
						
						// default values
						if (this.getSrc() === "") this.setSrc("Damage: \\2d+4\\");
						if (this.getView() === undefined) this.setView("html");
						$("#dest").attr("src", "dest.html");
					},
				};
			})();
			
			var parser;
			
			$(function() {
				$.ajax({
					type: "GET",
					url: "fluorite5.pegjs",
					dataType: "text",
					success: function(data) {
						try {
							parser = PEG.buildParser(data, {
								cache: true,
								allowedStartRules: [
									"Expression",
									"ExpressionPlain",
								],
							});
							form.setStatus("");
							form.initialize(changed);
						} catch(e) {
							form.setStatus("Parser: Syntax Error: " + e);
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						form.setStatus("Parser: Network Error: " + textStatus);
					},
				})
			});
			
			var src;
			var view;
			
			function changed()
			{
				var src2 = form.getSrc();
				var view2 = form.getView();
				var res;
				if (src === src2 && view === view2) return;
				
				src = src2;
				view = view2;
				
				try {
					if (view === "html") {
						res = parser.parse(src, {
							startRule: "Expression",
						});
					} else if (view === "plain") {
						res = parser.parse(src, {
							startRule: "ExpressionPlain",
						});
					} else if (view === "dump") {
						res = parser.parse(src, {
							startRule: "Expression",
						});
					}
				} catch(e) {
					form.setDestView("plain");
					form.setDestText(e);
					return;
				}
				
				form.setDestView(view);
				if (view === "html") {
					form.setDestHTML(buildHTMLRes(res));
				} else if (view === "plain") {
					form.setDestText(res);
				} else if (view === "dump") {
					form.setDestText(jsDump.parse(res));
				}
			}

			function buildHTMLRes(res)
			{
				var html = [convHtml(res[0])];

				for (var i = 1; i < res.length; i += 2) {
					buildHTMLFormula(html, res[i][0], res[i][1]);
					html.push(convHtml(res[i + 1]));
				}

				return html.join("");
			}

			function buildHTMLFormula(html, src, code)
			{
				var buttonScript = 'href="javascript: void(0);" onclick="dicebot_script_openclose(this)"';
				var buttonReport = 'href="javascript: void(0);" onclick="dicebot_report_openclose(this)"';
				var vm = {
					dices: [],
				};
				var res;
				try {
					res = code(vm, "get");
				} catch(e) {
					res = "" + e;
				}
				
				html.push('<span class="dicebot_container">');
				{
					html.push('<span class="dicebot_script_container">');
					{
						html.push('<span class="dicebot_script">');
						{
							html.push('<a ' + buttonScript + '>');
							html.push(convHtml(src));
							html.push("</a>");
						}
						html.push("</span>");

						html.push('<span class="dicebot_report">');
						{
							var report = vm.dices.map(function(item) {
								return "[" + item.join(", ") + "]";
							}).join(", ");

							html.push('<a ' + buttonReport + '>');
							html.push(report);
							html.push('</a>');
						}
						html.push("</span>");

						html.push('<a class="dicebot_equal" ' + buttonReport + '>=</a>');
					}
					html.push("</span>");

					html.push('<span class="dicebot_result">');
					{
						html.push('<a ' + buttonScript + '>');
						html.push(convHtml(res));
						html.push("</a>");
					}
					html.push("</span>");
				}
				html.push("</span>");
			}

		</script>
	</head>
	<body>
		<div id="container">
			<table>
				<tr id="tr_main">
					<td>
						<table>
							<tr id="tr_main">
								<td rowspan="2"><textarea id="src"></textarea></td>
								<td><iframe id="dest"></iframe></td>
							</tr>
							<tr>
								<td>
									<input type="radio" name="view" value="html">HTML
									<input type="radio" name="view" value="plain">Plain
									<input type="radio" name="view" value="dump">Dump
								</td>
							</tr>
						</table>
					</td>
				</tr>
				<tr>
					<td id="status"></td>
				</tr>
				<tr>
					<td>
						Browser: Mozilla Firefox 44.0
					</td>
				</tr>
			</table>
		</div>
	</body>
</html>
